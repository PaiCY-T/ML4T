---
epic: ML4T-Alpha
task_number: 2
title: Dynamic Position Sizing (Kelly + Volatility Targeting)
description: Implement intelligent position sizing using Kelly Criterion and volatility targeting for optimal capital allocation
status: pending
created: 2025-09-22T07:50:00Z
updated: 2025-09-22T07:50:00Z
assignee: null
depends_on: []
parallel: true
layer: 1
size: M
estimated_hours: 35
---

# Task 2: Dynamic Position Sizing (Kelly + Volatility Targeting)

## Overview

Replace static equal-weight position sizing with intelligent dynamic allocation using Kelly Criterion principles, volatility targeting, and Taiwan market-specific constraints to optimize risk-adjusted returns.

## Objectives

- **Primary**: Implement Kelly Criterion-based position sizing with Taiwan market adaptations
- **Secondary**: Add volatility targeting to maintain consistent portfolio risk (15% annual vol)
- **Tertiary**: Integrate with regime detection for regime-aware position scaling

## Technical Requirements

### Core Algorithm Components

**Kelly Criterion Implementation**
```python
# Classic Kelly formula adapted for trading
def kelly_fraction(win_rate, avg_win, avg_loss, confidence_adjustment=0.5):
    """
    f* = (bp - q) / b
    where:
    - b = odds received (avg_win / |avg_loss|)
    - p = win_rate
    - q = 1 - win_rate
    - confidence_adjustment = fraction of full Kelly (conservative)
    """
    b = avg_win / abs(avg_loss)
    p = win_rate
    q = 1 - p

    kelly_f = (b * p - q) / b
    return kelly_f * confidence_adjustment  # Half-Kelly conservative approach
```

**Volatility Targeting System**
```python
# Target 15% annual portfolio volatility
def volatility_adjusted_size(base_size, asset_vol, target_portfolio_vol=0.15):
    """
    Adjust position size based on asset volatility to maintain target portfolio vol
    """
    vol_adjustment = target_portfolio_vol / max(asset_vol, 0.05)
    return base_size * vol_adjustment
```

**Taiwan Market Constraints**
- **Maximum Position**: 20% of portfolio (regulatory/liquidity limits)
- **Minimum Position**: 2% of portfolio (meaningful allocation)
- **Liquidity Adjustment**: Scale down based on daily volume vs position size
- **Correlation Adjustment**: Reduce correlated positions in tech-heavy portfolio

### Position Sizing Framework

**Multi-Factor Position Calculation**
```python
class DynamicPositionSizer:
    def calculate_optimal_size(self, signal_data, market_context):
        # 1. Base Kelly calculation from historical performance
        kelly_size = self.kelly_fraction(
            win_rate=signal_data.historical_win_rate,
            avg_win=signal_data.avg_winning_return,
            avg_loss=signal_data.avg_losing_return
        )

        # 2. Volatility adjustment for risk targeting
        vol_adjusted = self.volatility_targeting(
            kelly_size,
            asset_vol=signal_data.volatility,
            target_vol=0.15
        )

        # 3. Signal strength scaling
        signal_scaled = vol_adjusted * signal_data.signal_strength

        # 4. Taiwan market constraints
        final_size = self.apply_taiwan_constraints(
            signal_scaled,
            liquidity=signal_data.avg_volume,
            sector_concentration=market_context.tech_weight
        )

        return np.clip(final_size, 0.02, 0.20)  # 2-20% range
```

### Taiwan Market Specific Adaptations

**Liquidity Constraints**
- **Volume Check**: Position size cannot exceed 5% of 20-day average volume
- **Market Impact**: Reduce size for low-liquidity stocks (Volume < NT$50M daily)
- **Price Impact**: Model expected slippage based on position size vs float

**Sector Concentration Management**
```python
# Taiwan market is 65%+ technology stocks
def adjust_for_sector_concentration(base_sizes, sector_weights):
    """
    Reduce individual tech stock positions when tech sector is overweight
    """
    tech_total = sum(size for stock, size in base_sizes.items()
                    if get_sector(stock) == 'technology')

    if tech_total > 0.70:  # If tech allocation > 70%
        tech_reduction = 0.70 / tech_total
        # Scale down tech positions proportionally

    return adjusted_sizes
```

**Regulatory Compliance**
- **Single Stock Limit**: Maximum 20% in any individual stock
- **Sector Limit**: Maximum 70% in technology sector
- **Cash Reserve**: Minimum 5% cash for rebalancing and opportunities
- **Margin Requirements**: No leverage allowed (Taiwan retail regulations)

## Implementation Plan

### Phase 1: Core Kelly Implementation (Week 1)

**Day 1-2: Historical Performance Analysis**
- Calculate win rates and return distributions for momentum signals
- Analyze return patterns across different market regimes
- Build historical performance database for Kelly calculations

**Day 3-4: Kelly Criterion Engine**
- Implement classic Kelly formula with confidence adjustments
- Add historical performance tracking and updates
- Test with historical Taiwan stock data

**Day 5: Integration Testing**
- Integrate Kelly sizer with existing momentum strategy
- Validate against equal-weight baseline
- Initial performance comparison

### Phase 2: Volatility Targeting & Constraints (Week 2)

**Day 6-7: Volatility Targeting**
- Implement portfolio volatility targeting (15% annual)
- Add individual asset volatility calculation and adjustment
- Test volatility-adjusted position sizing

**Day 8-9: Taiwan Market Constraints**
- Add liquidity-based position adjustment
- Implement sector concentration limits
- Add regulatory compliance checks

**Day 10: Final Integration**
- Combine all position sizing components
- Comprehensive testing with historical data
- Performance validation vs baseline

## Deliverables

### Core Implementation

**Position Sizing Engine**
```python
# /src/position_sizing/dynamic_sizer.py
class DynamicPositionSizer:
    def __init__(self, target_vol=0.15, max_position=0.20, min_position=0.02):
        self.target_vol = target_vol
        self.max_position = max_position
        self.min_position = min_position
        self.performance_tracker = PerformanceTracker()

    def kelly_fraction(self, expected_return, win_rate, avg_win, avg_loss):
        """Calculate Kelly optimal fraction"""

    def volatility_adjusted_size(self, base_size, asset_vol, target_vol=0.15):
        """Adjust size for volatility targeting"""

    def apply_liquidity_constraints(self, size, daily_volume, position_value):
        """Reduce size based on liquidity constraints"""

    def apply_sector_limits(self, positions, sector_data):
        """Apply Taiwan sector concentration limits"""

    def calculate_position_size(self, signal_data, market_context):
        """Main entry point - calculate optimal position size"""
```

**Performance Tracking**
```python
# /src/position_sizing/performance_tracker.py
class PerformanceTracker:
    def __init__(self):
        self.trade_history = []
        self.performance_metrics = {}

    def record_trade(self, symbol, entry_date, exit_date, return_pct):
        """Record trade outcome for Kelly calculation updates"""

    def get_historical_stats(self, symbol=None, lookback_days=252):
        """Get win rate, avg win/loss for Kelly calculations"""

    def update_kelly_parameters(self):
        """Update Kelly parameters based on recent performance"""
```

**Risk Management Integration**
```python
# /src/position_sizing/risk_manager.py
class PositionRiskManager:
    def __init__(self, max_portfolio_risk=0.15):
        self.max_portfolio_risk = max_portfolio_risk

    def calculate_portfolio_risk(self, positions, correlations, volatilities):
        """Calculate expected portfolio volatility"""

    def check_concentration_limits(self, positions):
        """Verify sector and single-stock limits"""

    def suggest_rebalancing(self, current_positions, target_positions):
        """Suggest minimum trades to reach target allocation"""
```

### Configuration & Parameters

**Position Sizing Configuration**
```yaml
# /config/position_sizing_config.yml
kelly_parameters:
  confidence_adjustment: 0.5    # Half-Kelly conservative approach
  min_trades_for_kelly: 20     # Minimum trades before using Kelly
  lookback_period: 252         # Days for historical analysis
  update_frequency: 'weekly'   # How often to recalculate Kelly parameters

volatility_targeting:
  target_portfolio_vol: 0.15   # 15% annual volatility target
  vol_lookback_days: 60        # Days for volatility calculation
  vol_adjustment_max: 3.0      # Maximum vol adjustment multiplier
  vol_adjustment_min: 0.3      # Minimum vol adjustment multiplier

taiwan_constraints:
  max_single_position: 0.20    # 20% maximum in single stock
  min_position_size: 0.02      # 2% minimum meaningful allocation
  max_tech_sector: 0.70        # 70% maximum in technology
  min_cash_reserve: 0.05       # 5% minimum cash
  max_volume_participation: 0.05  # 5% of 20-day avg volume max

liquidity_requirements:
  min_daily_volume: 50_000_000    # NT$50M minimum daily volume
  volume_lookback: 20             # Days for average volume calculation
  market_impact_threshold: 0.02   # 2% expected impact threshold
```

### Testing Framework

**Unit Tests**
```python
# /tests/position_sizing/test_dynamic_sizer.py
class TestDynamicPositionSizer:
    def test_kelly_calculation(self):
        """Test Kelly fraction calculation with known inputs"""

    def test_volatility_targeting(self):
        """Test vol targeting maintains portfolio risk"""

    def test_taiwan_constraints(self):
        """Test Taiwan market constraint application"""

    def test_sector_concentration(self):
        """Test tech sector limits enforcement"""

    def test_liquidity_adjustment(self):
        """Test position size reduction for illiquid stocks"""

# /tests/position_sizing/test_integration.py
class TestPositionSizingIntegration:
    def test_with_momentum_strategy(self):
        """Test integration with momentum signal generation"""

    def test_regime_interaction(self):
        """Test interaction with regime detection adjustments"""

    def test_historical_performance(self):
        """Test vs equal weight baseline over historical period"""
```

**Performance Benchmarks**
```python
# Expected improvements vs equal-weight baseline:
benchmarks = {
    'sharpe_improvement': 0.15,      # +0.15 Sharpe ratio points
    'volatility_control': 0.15,     # Target 15% annual volatility
    'max_drawdown_reduction': 0.02, # -2% max drawdown improvement
    'return_enhancement': 0.01      # +1% annual return improvement
}
```

## Success Criteria

### Performance Targets
- ✅ **Sharpe Ratio Improvement**: +0.15 points vs equal-weight baseline
- ✅ **Volatility Control**: Portfolio vol within 13-17% range (target 15%)
- ✅ **Drawdown Reduction**: Max drawdown improved by 2%+ vs baseline
- ✅ **Return Enhancement**: Annual return improved by 1%+ through better allocation

### Technical Validation
- ✅ **Kelly Accuracy**: Kelly parameters reflect actual historical performance
- ✅ **Volatility Targeting**: Portfolio vol stays within target range 80%+ of time
- ✅ **Constraint Compliance**: 100% compliance with Taiwan market limits
- ✅ **Performance Attribution**: Position sizing contributes measurably to returns

### Risk Management
- ✅ **Concentration Control**: No single position >20%, tech sector <70%
- ✅ **Liquidity Compliance**: Position sizes respect volume constraints
- ✅ **Stability**: Position sizing doesn't create excessive turnover
- ✅ **Robustness**: System handles edge cases (low volume, extreme signals)

## Integration Points

### Upstream Dependencies
- **Signal Generation**: Requires momentum signal strength and confidence scores
- **Historical Data**: Needs trade history for Kelly parameter calculation
- **Market Data**: Requires volatility and volume data for constraints

### Downstream Integration
- **Task 1**: Will receive regime adjustments for position scaling
- **Task 4**: Multi-regime strategy will use dynamic position sizes
- **Task 6**: Historical validation will test position sizing effectiveness

### Data Flow
```
Historical Performance Data
    ↓
Kelly Parameter Calculation
    ↓
Signal Strength + Asset Volatility
    ↓
Base Position Size Calculation
    ↓
Taiwan Market Constraints Application
    ↓
Final Position Sizes
    ↓
Portfolio Construction + Risk Monitoring
```

## Risk Management

### Implementation Risks
- **Parameter Instability**: Kelly parameters may be unstable with limited trade history
  - *Mitigation*: Use conservative half-Kelly approach, minimum trade requirements
- **Overfitting**: Position sizing optimized on historical data may not generalize
  - *Mitigation*: Out-of-sample testing, simple parameter structure

### Market Risks
- **Correlation Underestimation**: Taiwan tech stocks may be more correlated than modeled
  - *Mitigation*: Conservative sector limits, correlation stress testing
- **Liquidity Evaporation**: Market stress may reduce liquidity below modeled levels
  - *Mitigation*: Dynamic volume monitoring, emergency position size reduction

### Operational Risks
- **Calculation Errors**: Position sizing errors could lead to inappropriate risk taking
  - *Mitigation*: Extensive testing, position size validation checks
- **System Failures**: Position sizing system failures during rebalancing
  - *Mitigation*: Fallback to equal-weight, manual override capabilities

## Taiwan Market Context

### Unique Characteristics
- **High Concentration**: Technology sector dominates market cap
- **Retail Heavy**: Significant retail investor participation vs institutional
- **Policy Sensitive**: Government actions significantly impact markets
- **Export Dependent**: Global economic conditions affect most large stocks

### Historical Patterns
- **2014-2017**: Tech boom required concentration management
- **2018-2019**: Trade war showed importance of diversification
- **2020-2021**: WFH demand benefited concentrated tech approach
- **2022-2024**: Interest rate sensitivity required vol management

### Regulatory Environment
- **Position Limits**: Retail investors limited in margin/leverage usage
- **Sector Concentration**: No formal limits but prudential risk management
- **Liquidity**: T+2 settlement, daily price limits affect position entry/exit
- **Reporting**: Large position reporting requirements for institutional investors

## Future Enhancements

### Advanced Features
- **Multi-Asset Kelly**: Extend to bonds, commodities, currencies
- **Dynamic Correlation**: Real-time correlation adjustment for tech concentration
- **Regime-Aware Kelly**: Different Kelly parameters for different market regimes
- **Transaction Cost Integration**: Include expected transaction costs in Kelly calculation

### Machine Learning Integration
- **Predictive Volatility**: ML models for volatility forecasting
- **Optimal Rebalancing**: ML-based rebalancing frequency optimization
- **Risk Factor Models**: Factor-based risk models for better portfolio construction
- **Alternative Risk Measures**: CVaR, drawdown-based risk measures vs volatility