---
epic: ML4T-Alpha
task_number: 4
title: Multi-Regime Strategy Logic
description: Integrate regime detection with enhanced factors for adaptive strategy behavior across market conditions
status: pending
created: 2025-09-22T08:15:00Z
updated: 2025-09-22T08:15:00Z
assignee: null
depends_on: [1, 2, 3]
parallel: false
layer: 2
size: L
estimated_hours: 50
---

# Task 4: Multi-Regime Strategy Logic

## Overview

Create intelligent strategy orchestration that adapts momentum signals, position sizing, and trading behavior based on market regime detection, enhanced factors, and Taiwan market conditions for optimal performance across all market environments.

## Objectives

- **Primary**: Integrate regime detection, dynamic position sizing, and enhanced factors into unified strategy logic
- **Secondary**: Achieve consistent performance across Bull/Bear/Crisis/Sideways market regimes
- **Tertiary**: Create adaptive strategy parameters that automatically adjust to changing market conditions

## Technical Requirements

### Strategy Architecture Framework

**Multi-Regime Strategy Engine**
```python
class MultiRegimeStrategy:
    def __init__(self):
        self.regime_detector = TaiwanMarketRegimeDetector()
        self.position_sizer = DynamicPositionSizer()
        self.factor_calculator = EnhancedFactorCalculator()
        self.regime_configs = self.load_regime_configurations()

    def generate_signals(self, market_data, regime_context):
        """
        Generate trading signals adapted to current market regime
        """
        # 1. Detect current market regime
        current_regime, confidence = self.regime_detector.detect_regime(
            market_data.index_prices
        )

        # 2. Calculate enhanced factors
        factors = self.factor_calculator.calculate_all_factors(
            market_data.prices,
            market_data.volumes,
            market_data.metadata
        )

        # 3. Apply regime-specific adjustments
        regime_config = self.regime_configs[current_regime]
        adjusted_factors = self.apply_regime_adjustments(
            factors, regime_config
        )

        # 4. Generate base signals
        base_signals = self.calculate_momentum_scores(adjusted_factors)

        # 5. Apply regime-specific filtering
        filtered_signals = self.apply_regime_filters(
            base_signals, current_regime, confidence
        )

        # 6. Calculate dynamic position sizes
        position_sizes = self.position_sizer.calculate_positions(
            filtered_signals, market_data, current_regime
        )

        return {
            'regime': current_regime,
            'confidence': confidence,
            'signals': filtered_signals,
            'position_sizes': position_sizes,
            'factor_scores': adjusted_factors
        }
```

### Regime-Specific Strategy Configurations

**Bull Market Strategy**
```python
# Optimized for trending markets with strong momentum
bull_config = {
    'factor_weights': {
        'volume_adjusted_momentum': 0.40,    # Higher momentum weight
        'volatility_adjusted_momentum': 0.25,
        'multi_timeframe_momentum': 0.20,
        'enhanced_rsi': 0.10,               # Lower mean reversion
        'momentum_acceleration': 0.05
    },
    'selection_criteria': {
        'min_signal_strength': 0.3,         # Lower threshold for entry
        'max_positions': 8,                 # More concentrated
        'sector_diversification': False     # Allow tech concentration
    },
    'position_adjustments': {
        'base_multiplier': 1.2,             # Increase position sizes
        'momentum_scaling': 1.5,            # Amplify strong signals
        'volatility_tolerance': 0.20        # Higher vol tolerance
    },
    'exit_criteria': {
        'trailing_stop': 0.12,              # 12% trailing stop
        'momentum_reversal_threshold': -0.2, # Exit on momentum reversal
        'regime_change_exit': True          # Exit if regime changes
    }
}
```

**Bear Market Strategy**
```python
# Defensive positioning with capital preservation focus
bear_config = {
    'factor_weights': {
        'volume_adjusted_momentum': 0.20,    # Reduced momentum weight
        'volatility_adjusted_momentum': 0.30, # Higher vol adjustment
        'multi_timeframe_momentum': 0.15,
        'enhanced_rsi': 0.25,               # Higher mean reversion
        'momentum_acceleration': 0.10
    },
    'selection_criteria': {
        'min_signal_strength': 0.6,         # Higher threshold
        'max_positions': 3,                 # More concentrated defense
        'sector_diversification': True      # Avoid concentration
    },
    'position_adjustments': {
        'base_multiplier': 0.4,             # Reduce position sizes
        'momentum_scaling': 0.8,            # Dampen signals
        'volatility_tolerance': 0.12        # Lower vol tolerance
    },
    'exit_criteria': {
        'trailing_stop': 0.08,              # Tighter stops
        'momentum_reversal_threshold': -0.1,
        'max_holding_period': 30           # Shorter holds
    }
}
```

**Crisis Market Strategy**
```python
# Capital preservation with minimal exposure
crisis_config = {
    'factor_weights': {
        'volume_adjusted_momentum': 0.15,
        'volatility_adjusted_momentum': 0.40, # Highest vol weight
        'multi_timeframe_momentum': 0.10,
        'enhanced_rsi': 0.30,               # High mean reversion
        'momentum_acceleration': 0.05
    },
    'selection_criteria': {
        'min_signal_strength': 0.8,         # Very high threshold
        'max_positions': 2,                 # Minimal positions
        'quality_filter': True              # Only highest quality stocks
    },
    'position_adjustments': {
        'base_multiplier': 0.2,             # Very small positions
        'momentum_scaling': 0.5,            # Heavy dampening
        'volatility_tolerance': 0.08        # Very low vol tolerance
    },
    'exit_criteria': {
        'trailing_stop': 0.05,              # Very tight stops
        'max_holding_period': 10,           # Very short holds
        'volatility_exit': 0.30            # Exit if vol > 30%
    }
}
```

**Sideways Market Strategy**
```python
# Balanced approach with mean reversion bias
sideways_config = {
    'factor_weights': {
        'volume_adjusted_momentum': 0.25,
        'volatility_adjusted_momentum': 0.25,
        'multi_timeframe_momentum': 0.25,
        'enhanced_rsi': 0.20,               # Balanced approach
        'momentum_acceleration': 0.05
    },
    'selection_criteria': {
        'min_signal_strength': 0.4,         # Moderate threshold
        'max_positions': 5,                 # Moderate concentration
        'rotation_bias': True               # Favor rotation plays
    },
    'position_adjustments': {
        'base_multiplier': 0.9,             # Slightly reduced
        'momentum_scaling': 1.0,            # Neutral scaling
        'volatility_tolerance': 0.15        # Moderate tolerance
    },
    'exit_criteria': {
        'trailing_stop': 0.10,              # Moderate stops
        'mean_reversion_exit': True,        # Exit on reversion
        'momentum_decay_threshold': 0.1     # Exit if momentum fades
    }
}
```

### Advanced Strategy Logic Components

**Signal Combination & Weighting**
```python
def calculate_regime_adjusted_scores(self, factors, regime_config):
    """
    Combine factors with regime-specific weights
    """
    weights = regime_config['factor_weights']

    composite_score = (
        factors['volume_adjusted_momentum'] * weights['volume_adjusted_momentum'] +
        factors['volatility_adjusted_momentum'] * weights['volatility_adjusted_momentum'] +
        factors['multi_timeframe_momentum'] * weights['multi_timeframe_momentum'] +
        factors['enhanced_rsi'] * weights['enhanced_rsi'] +
        factors['momentum_acceleration'] * weights['momentum_acceleration']
    )

    return composite_score
```

**Regime Transition Handling**
```python
def handle_regime_transition(self, old_regime, new_regime, confidence):
    """
    Manage strategy behavior during regime changes
    """
    transition_actions = []

    if confidence > 0.8:  # High confidence transition
        if old_regime == 'bull' and new_regime in ['bear', 'crisis']:
            # Immediate defensive action
            transition_actions.append('reduce_positions_50pct')
            transition_actions.append('tighten_stops')

        elif old_regime in ['bear', 'crisis'] and new_regime == 'bull':
            # Gradual offensive action
            transition_actions.append('increase_positions_gradually')
            transition_actions.append('expand_universe')

    elif confidence > 0.6:  # Medium confidence
        # Conservative transition
        transition_actions.append('maintain_current_positions')
        transition_actions.append('monitor_closely')

    return transition_actions
```

**Portfolio Construction Logic**
```python
def construct_portfolio(self, signals, position_sizes, regime_config):
    """
    Build final portfolio considering regime constraints
    """
    selection_criteria = regime_config['selection_criteria']

    # 1. Filter signals by minimum strength
    min_strength = selection_criteria['min_signal_strength']
    qualified_signals = signals[signals.strength >= min_strength]

    # 2. Apply diversification constraints
    if selection_criteria.get('sector_diversification', False):
        qualified_signals = self.apply_sector_limits(qualified_signals)

    # 3. Select top N positions
    max_positions = selection_criteria['max_positions']
    top_signals = qualified_signals.nlargest(max_positions, 'strength')

    # 4. Calculate final position sizes
    final_positions = {}
    for _, signal in top_signals.iterrows():
        base_size = position_sizes[signal.symbol]
        regime_multiplier = regime_config['position_adjustments']['base_multiplier']
        final_size = base_size * regime_multiplier
        final_positions[signal.symbol] = final_size

    return final_positions
```

## Implementation Plan

### Phase 1: Core Integration Framework (Week 1-2)

**Week 1: Basic Integration**
- **Day 1-2**: Create multi-regime strategy base class
- **Day 3-4**: Implement regime configuration system
- **Day 5**: Basic signal generation integration

**Week 2: Regime Logic**
- **Day 6-7**: Implement regime-specific strategy configurations
- **Day 8-9**: Add regime transition handling logic
- **Day 10**: Initial integration testing

### Phase 2: Advanced Logic & Optimization (Week 2-3)

**Week 3: Portfolio Construction**
- **Day 11-12**: Implement portfolio construction logic
- **Day 13-14**: Add exit criteria and risk management
- **Day 15**: Advanced strategy testing

### Phase 3: Validation & Refinement (Week 3-4)

**Week 4: Performance Validation**
- **Day 16-17**: Historical regime performance testing
- **Day 18-19**: Strategy parameter optimization
- **Day 20**: Final integration with backtesting framework

## Deliverables

### Core Strategy Engine

**Multi-Regime Strategy Controller**
```python
# /src/strategy/multi_regime_strategy.py
class MultiRegimeStrategy:
    def __init__(self, config_path='config/regime_strategies.yml'):
        self.regime_detector = TaiwanMarketRegimeDetector()
        self.position_sizer = DynamicPositionSizer()
        self.factor_calculator = EnhancedFactorCalculator()
        self.regime_configs = self.load_regime_configurations(config_path)
        self.current_regime = None
        self.regime_history = []

    def generate_daily_signals(self, market_data):
        """Main entry point for daily signal generation"""

    def handle_regime_transition(self, old_regime, new_regime, confidence):
        """Manage strategy during regime changes"""

    def construct_portfolio(self, signals, current_positions):
        """Build final portfolio from signals"""

    def calculate_regime_adjusted_scores(self, factors, regime):
        """Apply regime-specific factor weights"""

    def apply_exit_criteria(self, current_positions, market_data):
        """Check exit conditions based on regime"""
```

**Regime Configuration Manager**
```python
# /src/strategy/regime_config_manager.py
class RegimeConfigManager:
    def __init__(self):
        self.regime_configs = {}
        self.parameter_history = {}

    def load_regime_configurations(self, config_path):
        """Load regime-specific strategy parameters"""

    def update_regime_config(self, regime, parameter_updates):
        """Update regime parameters based on performance"""

    def optimize_regime_parameters(self, historical_data):
        """Optimize parameters using historical performance"""

    def validate_config_consistency(self):
        """Ensure all regime configs are valid"""
```

**Portfolio Construction Engine**
```python
# /src/strategy/portfolio_constructor.py
class PortfolioConstructor:
    def __init__(self, taiwan_constraints=True):
        self.taiwan_constraints = taiwan_constraints

    def select_positions(self, signals, regime_config):
        """Select positions based on regime criteria"""

    def apply_diversification_constraints(self, positions, regime):
        """Apply regime-specific diversification rules"""

    def calculate_target_weights(self, selected_positions, regime_config):
        """Calculate target position weights"""

    def generate_trades(self, current_portfolio, target_portfolio):
        """Generate trade list to reach target portfolio"""
```

### Strategy Configuration System

**Regime Strategy Configurations**
```yaml
# /config/regime_strategies.yml
bull_market:
  factor_weights:
    volume_adjusted_momentum: 0.40
    volatility_adjusted_momentum: 0.25
    multi_timeframe_momentum: 0.20
    enhanced_rsi: 0.10
    momentum_acceleration: 0.05

  selection_criteria:
    min_signal_strength: 0.3
    max_positions: 8
    sector_diversification: false
    quality_filter: false

  position_adjustments:
    base_multiplier: 1.2
    momentum_scaling: 1.5
    volatility_tolerance: 0.20

  exit_criteria:
    trailing_stop: 0.12
    momentum_reversal_threshold: -0.2
    regime_change_exit: true
    max_holding_period: null

bear_market:
  factor_weights:
    volume_adjusted_momentum: 0.20
    volatility_adjusted_momentum: 0.30
    multi_timeframe_momentum: 0.15
    enhanced_rsi: 0.25
    momentum_acceleration: 0.10

  selection_criteria:
    min_signal_strength: 0.6
    max_positions: 3
    sector_diversification: true
    quality_filter: true

  position_adjustments:
    base_multiplier: 0.4
    momentum_scaling: 0.8
    volatility_tolerance: 0.12

  exit_criteria:
    trailing_stop: 0.08
    momentum_reversal_threshold: -0.1
    max_holding_period: 30

crisis_market:
  factor_weights:
    volume_adjusted_momentum: 0.15
    volatility_adjusted_momentum: 0.40
    multi_timeframe_momentum: 0.10
    enhanced_rsi: 0.30
    momentum_acceleration: 0.05

  selection_criteria:
    min_signal_strength: 0.8
    max_positions: 2
    sector_diversification: true
    quality_filter: true

  position_adjustments:
    base_multiplier: 0.2
    momentum_scaling: 0.5
    volatility_tolerance: 0.08

  exit_criteria:
    trailing_stop: 0.05
    max_holding_period: 10
    volatility_exit: 0.30

sideways_market:
  factor_weights:
    volume_adjusted_momentum: 0.25
    volatility_adjusted_momentum: 0.25
    multi_timeframe_momentum: 0.25
    enhanced_rsi: 0.20
    momentum_acceleration: 0.05

  selection_criteria:
    min_signal_strength: 0.4
    max_positions: 5
    rotation_bias: true

  position_adjustments:
    base_multiplier: 0.9
    momentum_scaling: 1.0
    volatility_tolerance: 0.15

  exit_criteria:
    trailing_stop: 0.10
    mean_reversion_exit: true
    momentum_decay_threshold: 0.1
```

### Testing & Validation Framework

**Strategy Performance Tests**
```python
# /tests/strategy/test_multi_regime_strategy.py
class TestMultiRegimeStrategy:
    def test_regime_signal_generation(self):
        """Test signal generation for each regime"""

    def test_regime_transitions(self):
        """Test strategy behavior during regime changes"""

    def test_portfolio_construction(self):
        """Test portfolio construction logic"""

    def test_exit_criteria(self):
        """Test exit condition enforcement"""

    def test_taiwan_constraints(self):
        """Test Taiwan market-specific constraints"""

# /tests/strategy/test_regime_performance.py
class TestRegimePerformance:
    def test_bull_market_performance(self):
        """Test performance during bull market periods"""

    def test_bear_market_performance(self):
        """Test performance during bear market periods"""

    def test_crisis_performance(self):
        """Test performance during crisis periods"""

    def test_regime_consistency(self):
        """Test consistent performance across regimes"""
```

## Success Criteria

### Strategy Performance Targets
- ✅ **Regime-Specific Performance**: Each regime configuration outperforms static strategy by 2%+ annually
- ✅ **Consistency**: Positive returns in 3 out of 4 regime types over historical period
- ✅ **Transition Management**: Smooth performance during regime transitions (max 5% drawdown)
- ✅ **Overall Improvement**: Combined multi-regime strategy achieves 12%+ annual returns

### Technical Validation
- ✅ **Integration Success**: All components (regime detection, factors, position sizing) work together
- ✅ **Configuration Flexibility**: Easy to modify regime parameters without code changes
- ✅ **Performance Attribution**: Clear measurement of regime strategy contributions
- ✅ **Robustness**: Strategy handles edge cases and regime uncertainty gracefully

### Risk Management
- ✅ **Drawdown Control**: Max drawdown <15% across all regime types
- ✅ **Position Limits**: Taiwan market constraints enforced automatically
- ✅ **Exit Discipline**: Exit criteria prevent large losses consistently
- ✅ **Regime Risk**: No single regime dominates performance (balanced contribution)

## Integration Points

### Component Dependencies
- **Task 1**: Taiwan Market Regime Detection provides regime classification
- **Task 2**: Dynamic Position Sizing provides intelligent position allocation
- **Task 3**: Enhanced Technical Factors provide improved signal quality

### Downstream Integration
- **Task 5**: Enhanced Backtesting Framework will test multi-regime strategy
- **Task 6**: Historical Validation will validate regime strategy performance
- **Task 7**: Real-Time Monitoring will track regime strategy behavior

### Data Flow Architecture
```
Market Data + Enhanced Factors
    ↓
Regime Detection + Classification
    ↓
Regime-Specific Strategy Configuration Selection
    ↓
Adjusted Factor Weighting + Signal Generation
    ↓
Dynamic Position Sizing + Portfolio Construction
    ↓
Exit Criteria Application + Risk Management
    ↓
Final Portfolio + Trade Generation
```

## Risk Management

### Strategy Risks
- **Regime Misclassification Risk**: Wrong regime detection leads to inappropriate strategy
  - *Mitigation*: Confidence thresholds, gradual transitions, regime uncertainty handling
- **Over-Optimization Risk**: Regime parameters overfitted to historical data
  - *Mitigation*: Out-of-sample testing, parameter stability analysis

### Market Risks
- **Regime Change Risk**: Rapid regime changes may cause whipsaw losses
  - *Mitigation*: Transition smoothing, confidence thresholds, defensive positioning
- **Taiwan Market Risk**: Strategy concentration in Taiwan market structure
  - *Mitigation*: Diversification constraints, international regime consideration

### Implementation Risks
- **Complexity Risk**: Multi-regime logic introduces system complexity
  - *Mitigation*: Modular design, extensive testing, clear documentation
- **Performance Risk**: Strategy switching may reduce overall performance
  - *Mitigation*: Performance monitoring, fallback to best-performing regime

## Taiwan Market Context

### Historical Regime Validation
- **2014-2017 Bull**: Tech boom period, momentum strategy optimal
- **2018-2019 Bear**: Trade war impact, defensive positioning crucial
- **2020 Crisis**: COVID crash, capital preservation strategy
- **2020-2021 Recovery**: Regime transition management critical
- **2022-2024 Sideways**: Mixed signals require balanced approach

### Taiwan-Specific Considerations
- **Technology Sector Dominance**: Regime strategies must handle tech concentration
- **Policy Sensitivity**: Government announcements trigger regime-like behavior
- **Retail Investor Behavior**: High retail participation affects momentum patterns
- **Export Dependency**: Global economic regimes influence Taiwan market regimes

## Future Enhancements

### Advanced Regime Strategies
- **Sector-Specific Regimes**: Different regime strategies for technology vs financial sectors
- **International Regime Integration**: US/China market regimes influence Taiwan strategy
- **Fundamental Regime Overlay**: Earnings cycle and economic data regime detection
- **Options Market Regimes**: Volatility regime detection from options markets

### Machine Learning Integration
- **Regime Prediction**: ML models to predict regime transitions
- **Dynamic Parameter Optimization**: Real-time strategy parameter adjustment
- **Multi-Model Ensemble**: Combine multiple regime detection approaches
- **Reinforcement Learning**: RL-based strategy optimization within regimes

### Risk Management Enhancements
- **Dynamic Risk Limits**: Regime-specific risk management parameters
- **Stress Testing**: Strategy performance under extreme regime scenarios
- **Portfolio Insurance**: Regime-aware hedging and protection strategies
- **Liquidity Management**: Regime-specific liquidity requirements and constraints