# Task 24: Transaction Cost Modeling

---
github: https://github.com/PaiCY-T/ML4T/issues/24
updated: 2025-09-23T17:33:28Z
epic: ML4T-Alpha-Rebuild
phase: 1
task_number: 24
title: Transaction Cost Modeling
created: 2025-09-23T13:07:08Z
status: not_started
effort: M
estimated_days: 2-3
dependencies: [21, 22]
parallel: true
assignee: TBD
priority: high
---
github: https://github.com/PaiCY-T/ML4T/issues/24

## Overview

Build a comprehensive transaction cost model specifically tailored for the Taiwan stock market, incorporating market microstructure, liquidity constraints, capacity limits, and regulatory costs to provide accurate backtesting and real-time trading cost estimates.

## Objectives

- Develop Taiwan market-specific transaction cost model
- Implement capacity limits and liquidity constraints
- Add comprehensive performance attribution with risk-adjusted metrics
- Create seamless backtesting framework integration
- Build real-time cost estimation for live trading

## Taiwan Market Transaction Cost Components

### Regulatory and Exchange Costs
- **Securities Transaction Tax**: 0.3% on stock sales (buyer exempt)
- **Brokerage Commission**: 0.1425% maximum (negotiable, typically 0.05-0.1%)
- **Exchange Fee**: 0.00025% of transaction value
- **Settlement Fee**: NT$1 per transaction
- **Centralized Depository Fee**: 0.02% annually for custody

### Market Microstructure Costs
- **Bid-Ask Spread**: Function of liquidity and volatility
- **Market Impact**: Temporary and permanent price impact
- **Timing Cost**: Opportunity cost of delayed execution
- **Slippage**: Execution price vs. decision price difference

### Taiwan-Specific Characteristics
- **Tick Size**: Variable based on price level (NT$0.01 to NT$5.00)
- **Order Size Limits**: Maximum 499 lots per order for retail
- **Circuit Breakers**: ±10% daily price limits affect execution
- **Foreign Ownership Limits**: 50% cap on individual foreign ownership

## Technical Requirements

### Transaction Cost Model Architecture
```
Market Data → Cost Calculator → Capacity Analyzer → Risk Adjuster
     ↓              ↓              ↓               ↓
Bid-Ask Feed → Impact Model → Liquidity Check → Attribution Engine
```

### Core Components

1. **Market Impact Model**
   - Temporary impact (price recovery)
   - Permanent impact (information content)
   - Non-linear impact based on order size vs ADV
   - Taiwan-specific calibration parameters

2. **Liquidity Analysis Engine**
   - Average Daily Volume (ADV) calculation
   - Liquidity-adjusted volume (LAV) estimation
   - Capacity constraints by stock and timeframe
   - Real-time liquidity monitoring

3. **Bid-Ask Spread Modeling**
   - Spread prediction based on volatility and volume
   - Time-of-day effects (morning/afternoon sessions)
   - Event-driven spread widening (earnings, news)
   - Cross-sectional spread analysis

4. **Cost Attribution Framework**
   - Component breakdown (taxes, commissions, impact)
   - Performance attribution with transaction costs
   - Risk-adjusted return calculations
   - Benchmark comparison with cost adjustments

## Acceptance Criteria

### Cost Model Implementation
- [ ] Comprehensive Taiwan transaction cost model implemented
- [ ] All regulatory costs (tax, commission, fees) included
- [ ] Market impact model calibrated for Taiwan stocks
- [ ] Bid-ask spread prediction model operational
- [ ] Capacity limits calculated for all tradeable universe

### Liquidity and Capacity Analysis
- [ ] ADV-based capacity calculations for all stocks
- [ ] Liquidity-adjusted volume estimates updated daily
- [ ] Real-time capacity monitoring during trading
- [ ] Position size recommendations based on capacity limits
- [ ] Turnover constraints for high-frequency strategies

### Performance Attribution
- [ ] Transaction cost breakdown for all trades
- [ ] Risk-adjusted performance metrics with costs
- [ ] Cost attribution by strategy component
- [ ] Benchmark comparison with transaction costs
- [ ] Cost efficiency analysis and optimization

### Integration and Performance
- [ ] Seamless backtesting framework integration
- [ ] Real-time cost estimation API operational
- [ ] Sub-100ms cost calculation for single stock
- [ ] Bulk cost estimation for portfolio rebalancing
- [ ] Historical cost analysis and trending

## Technical Implementation

### Market Impact Model
```python
class TaiwanMarketImpactModel:
    def __init__(self):
        # Taiwan-specific calibration parameters
        self.temp_impact_decay = 0.5  # Temporary impact decay rate
        self.perm_impact_factor = 0.3  # Permanent impact factor
        self.size_penalty_exp = 0.6   # Non-linear size penalty exponent
        
    def calculate_impact(self, order_size, adv, volatility, spread):
        """Calculate temporary and permanent market impact"""
        participation_rate = order_size / adv
        
        # Temporary impact (mean-reverting)
        temp_impact = (
            self.temp_impact_decay * 
            volatility * 
            (participation_rate ** self.size_penalty_exp)
        )
        
        # Permanent impact (information-based)
        perm_impact = (
            self.perm_impact_factor * 
            spread * 
            (participation_rate ** 0.5)
        )
        
        return {
            'temporary_impact': temp_impact,
            'permanent_impact': perm_impact,
            'total_impact': temp_impact + perm_impact
        }
```

### Taiwan Regulatory Cost Calculator
```python
class TaiwanCostCalculator:
    def __init__(self):
        self.transaction_tax_rate = 0.23  # 0.3% on sales
        self.max_commission_rate = 0.001425  # 0.1425% maximum
        self.exchange_fee_rate = 0.0000025  # 0.00025%
        self.settlement_fee = 1.0  # NT$1 per transaction
        
    def calculate_regulatory_costs(self, trade_value, trade_type, commission_rate=None):
        """Calculate all Taiwan regulatory and exchange costs"""
        costs = {}
        
        # Securities transaction tax (only on sales)
        if trade_type == 'sell':
            costs['transaction_tax'] = trade_value * self.transaction_tax_rate
        else:
            costs['transaction_tax'] = 0.0
            
        # Brokerage commission (both buy and sell)
        if commission_rate is None:
            commission_rate = 0.0008  # Typical rate for institutional
        costs['commission'] = trade_value * commission_rate
        
        # Exchange fee
        costs['exchange_fee'] = trade_value * self.exchange_fee_rate
        
        # Settlement fee
        costs['settlement_fee'] = self.settlement_fee
        
        costs['total_regulatory'] = sum(costs.values())
        
        return costs
```

### Liquidity and Capacity Analysis
```python
class LiquidityAnalyzer:
    def __init__(self):
        self.adv_window = 20  # 20-day ADV calculation
        self.capacity_threshold = 0.10  # Max 10% of ADV per day
        
    def calculate_capacity(self, symbol, strategy_horizon_days=1):
        """Calculate trading capacity for a symbol"""
        # Get historical volume data
        volume_data = self.get_volume_history(symbol, self.adv_window)
        
        # Calculate average daily volume
        adv = volume_data.mean()
        
        # Adjust for liquidity (exclude low-volume days)
        lav = volume_data[volume_data > adv * 0.3].mean()
        
        # Calculate capacity based on strategy horizon
        daily_capacity = lav * self.capacity_threshold
        strategy_capacity = daily_capacity * strategy_horizon_days
        
        return {
            'adv': adv,
            'lav': lav,
            'daily_capacity_shares': daily_capacity,
            'strategy_capacity_shares': strategy_capacity,
            'capacity_ntd': strategy_capacity * self.get_current_price(symbol)
        }
```

### Bid-Ask Spread Model
```python
class BidAskSpreadModel:
    def __init__(self):
        self.base_spread_factor = 0.21  # Base spread factor
        self.volatility_multiplier = 2.0
        self.volume_penalty = 0.5
        
    def predict_spread(self, symbol, current_time):
        """Predict bid-ask spread based on market conditions"""
        # Get current market data
        volatility = self.get_intraday_volatility(symbol)
        volume_ratio = self.get_current_volume_ratio(symbol)
        time_factor = self.get_time_of_day_factor(current_time)
        
        # Base spread from tick size and price
        price = self.get_current_price(symbol)
        tick_size = self.get_tick_size(price)
        min_spread = tick_size / price
        
        # Predicted spread
        predicted_spread = (
            self.base_spread_factor +
            self.volatility_multiplier * volatility +
            self.volume_penalty / volume_ratio
        ) * time_factor
        
        return max(predicted_spread, min_spread)
```

### Cost Attribution Framework
```python
class CostAttributor:
    def __init__(self):
        self.cost_calculator = TaiwanCostCalculator()
        self.impact_model = TaiwanMarketImpactModel()
        self.spread_model = BidAskSpreadModel()
        
    def attribute_trade_costs(self, trade):
        """Break down all costs for a trade"""
        attribution = {}
        
        # Regulatory costs
        reg_costs = self.cost_calculator.calculate_regulatory_costs(
            trade.value, trade.side, trade.commission_rate
        )
        attribution.update(reg_costs)
        
        # Market impact costs
        impact = self.impact_model.calculate_impact(
            trade.quantity, trade.adv, trade.volatility, trade.spread
        )
        attribution['market_impact'] = impact['total_impact'] * trade.value
        
        # Spread costs
        predicted_spread = self.spread_model.predict_spread(
            trade.symbol, trade.timestamp
        )
        attribution['spread_cost'] = predicted_spread * trade.value * 0.5
        
        # Timing costs (if execution delayed)
        if trade.timing_delay > 0:
            attribution['timing_cost'] = (
                trade.price_move_during_delay * trade.quantity
            )
        
        attribution['total_cost'] = sum(attribution.values())
        attribution['cost_bps'] = (attribution['total_cost'] / trade.value) * 10000
        
        return attribution
```

## Taiwan Market Calibration Data

### Historical Analysis Requirements
- **5 years** of intraday tick data for model calibration
- **Market impact analysis** across different market regimes
- **Spread behavior** during normal vs volatile periods
- **Capacity utilization** tracking for institutional trades

### Model Validation
- **Out-of-sample testing** with 1-year holdout period
- **Cross-validation** across different market conditions
- **Benchmark comparison** with actual execution costs
- **Regime analysis** (bull/bear/volatile markets)

## Integration Points

### Backtesting Framework Integration
```python
# Example integration with backtesting engine
def apply_transaction_costs(backtest_engine, cost_model):
    """Apply transaction costs to backtesting results"""
    for trade in backtest_engine.trades:
        cost_attribution = cost_model.attribute_trade_costs(trade)
        trade.execution_cost = cost_attribution['total_cost']
        trade.cost_bps = cost_attribution['cost_bps']
        
    # Adjust performance metrics
    backtest_engine.recalculate_performance_with_costs()
```

### Real-Time Trading Integration
```python
# Example real-time cost estimation
def estimate_execution_cost(symbol, quantity, side):
    """Estimate execution cost before placing order"""
    capacity = liquidity_analyzer.calculate_capacity(symbol)
    
    if abs(quantity) > capacity['daily_capacity_shares']:
        return {'error': 'Order size exceeds daily capacity'}
    
    cost_estimate = cost_attributor.attribute_trade_costs(
        create_hypothetical_trade(symbol, quantity, side)
    )
    
    return cost_estimate
```

## Definition of Done

1. Comprehensive Taiwan transaction cost model implemented
2. All regulatory costs accurately calculated and tested
3. Market impact model calibrated with Taiwan market data
4. Liquidity and capacity analysis operational
5. Performance attribution with cost breakdown functional
6. Backtesting framework integration complete
7. Real-time cost estimation API operational
8. Cost optimization recommendations generated
9. Historical cost analysis and trending available
10. Documentation and usage examples complete

## Dependencies

- **Task 21**: Point-in-Time Data Management System (required for historical analysis)
- **Task 22**: Data Quality Validation Framework (required for cost model validation)

## Parallel Execution

This task can be executed in parallel with Task 23 (Walk-Forward Validation Engine) as they operate on different aspects of the trading framework.

## Success Metrics

- Cost estimation accuracy within 10 basis points of actual costs
- Real-time cost calculation under 100ms response time
- 100% coverage of Taiwan regulatory cost components
- Capacity constraints prevent over-trading in illiquid stocks
- Performance attribution accuracy within 0.05% vs manual calculation
- Cost optimization recommendations improve net returns by 20+ basis points